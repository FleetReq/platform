name: Cleanup Free Tier Data

on:
  schedule:
    # Run daily at 02:00 UTC (after expired accounts cleanup at 00:00 UTC)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual triggering for testing

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete data older than 90 days for free tier users
        run: |
          response=$(curl -X POST https://fleetreq.vercel.app/api/cron/cleanup-free-tier-data \
            -H "Content-Type: application/json" \
            -w "\nHTTP_STATUS:%{http_code}" \
            -s)

          http_status=$(echo "$response" | grep "HTTP_STATUS" | cut -d':' -f2)
          body=$(echo "$response" | sed '/HTTP_STATUS/d')

          echo "Response: $body"
          echo "HTTP Status: $http_status"

          if [ "$http_status" -eq 200 ]; then
            echo "✅ Free tier data cleanup completed successfully"
            exit 0
          else
            echo "❌ Free tier data cleanup failed with status $http_status"
            exit 1
          fi
